<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        Part 1: Implementing a Directory Entry Stream in Rust
    </title><link href=/favicons/favicon.ico rel=icon type=image/png><link href="https://jproyo.github.io/ atom.xml" title="Tech, Science, Math and more..." rel=alternate type=application/atom+xml><link href=https://jproyo.github.io/main.css media=screen rel=stylesheet><script src=https://jproyo.github.io/elasticlunr.min.js></script><script src=https://jproyo.github.io/search_index.en.js></script><script src=https://jproyo.github.io/search.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><meta name=description><meta name=description><meta content="index, nofollow" name=robots><meta content="Tech, Science, Math and more..." property=og:title><meta content=article property=og:type><meta content=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/ property=og:url><meta property=og:description><meta content="Tech, Science, Math and more..." property=og:site_name><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://jproyo.github.io>Tech, Science, Math and more...</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/posts> Articles</a><a class=nav-links href=/tags> Tags</a></nav><nav class="socials nav-navs"><div class=search-container><input placeholder="üîé   Search" id=search type=search><div class=search-results><div class=search-results__items></div></div></div><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>Part 1: Implementing a Directory Entry Stream in Rust</h2><div class=meta>Posted on <time>2024-10-29</time><div class=post-tags><nav class="nav tags">üè∑: <a href=https://jproyo.github.io/tags/rust/>rust</a> ¬† <a href=https://jproyo.github.io/tags/async/>async</a> ¬† <a href=https://jproyo.github.io/tags/stream/>stream</a> ¬† <a href=https://jproyo.github.io/tags/filesystem/>filesystem</a> ¬† <a href=https://jproyo.github.io/tags/tutorial/>tutorial</a> ¬†</nav></div> ||<span> 6 minute read</span></div></div><h1>Table of Contents</h1><ul><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#part-1-understanding-a-custom-directory-entry-stream-in-rust>Part 1: Understanding a Custom Directory Entry Stream in Rust</a> <ul><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#the-core-structure>The Core Structure</a><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#state-machine-pattern>State Machine Pattern</a><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#deep-dive-implementing-a-stream-for-directory-entry-headers>Deep Dive: Implementing a Stream for Directory Entry Headers</a></li><ul><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#understanding-the-context>Understanding the Context</a><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#entry-structure>Entry Structure</a><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#stream-implementation>Stream Implementation</a></ul><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#why-a-state-machine>Why a State Machine?</a><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#the-header-file-structure>The Header File Structure</a><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#trade-offs-and-considerations>Trade-offs and Considerations</a></ul><li><a href=https://jproyo.github.io/posts/2024-10-29-implementing-directory-stream-in-rust/#conclusion>Conclusion</a></ul><section class=body><p><a href=https://jproyo.github.io/posts/2024-11-05-implementing-directory-stream-in-rust-part-2/>Part 2</a><h1 id=part-1-understanding-a-custom-directory-entry-stream-in-rust>Part 1: Understanding a Custom Directory Entry Stream in Rust</h1><p>Today, let's dive into an interesting implementation of <code>Stream</code> for directory entry iteration in Rust. This implementation showcases several advanced Rust concepts including async/await, state machines, and safe handling of file I/O.<blockquote><p><strong>SPOILER ALERT</strong>: This implementation will contain a naive implementaion of the stream directory reader, which is not performant because it will create multiple futures. Go to Part 2 to see a more robust implementation.</blockquote><h2 id=the-core-structure>The Core Structure</h2><p>The implementation centers around <code>DirEntriesIter</code>, which provides streaming access to directory entries in a custom filesystem format. Here's the key structure:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">DirEntriesIter</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">reader</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">BufReader<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>File<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
    <span class="z-variable z-other z-member z-rust">position</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u64</span>,
    <span class="z-variable z-other z-member z-rust">state</span><span class="z-punctuation z-separator z-type z-rust">:</span> State,
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ... other fields
</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h2 id=state-machine-pattern>State Machine Pattern</h2><p>One of the most interesting aspects is the use of an explicit state machine through an enum:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">State</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    ReadPosition<span class="z-punctuation z-separator z-rust">,</span>
    ReadFlag<span class="z-punctuation z-separator z-rust">,</span>
    ReadEntryName<span class="z-punctuation z-separator z-rust">,</span>
    ReadContent<span class="z-punctuation z-separator z-rust">,</span>
    ReadPath<span class="z-punctuation z-separator z-rust">,</span>
    Eof<span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>This state machine elegantly handles the sequential reading of directory entries, where each entry consists of:<ol><li>A flag indicating entry type<li>A null-terminated entry name<li>Either a content hash (32 bytes) or a symlink path</ol><h2 id=deep-dive-implementing-a-stream-for-directory-entry-headers>Deep Dive: Implementing a Stream for Directory Entry Headers</h2><h3 id=understanding-the-context>Understanding the Context</h3><p>Before diving into the implementation, let's understand what we're working with. We're reading a directory header file that acts as an index - it contains metadata and pointers (hashes) to the actual content files. Each entry in this header file represents:<ol><li>A flag indicating the entry type<li>The entry name as a null-terminated string<li>A 32-byte hash that points to another file containing the actual content</ol><p>This structure allows for efficient directory traversal without loading all file contents into memory.<h3 id=entry-structure>Entry Structure</h3><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">Entry</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">name</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-type z-rust">str</span>,
    <span class="z-variable z-other z-member z-rust">content_file_hash</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> [<span class="z-storage z-type z-rust">u8</span>; 32]
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>This simplified structure focuses on two key pieces of information:<ul><li><code>name</code>: A string slice representing the entry name<li><code>content_file_hash</code>: A 32-byte array slice that contains the hash pointing to the content file</ul><h3 id=stream-implementation>Stream Implementation</h3><p>Here's the adapted Stream implementation with detailed explanations:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> Stream <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DirEntriesIter</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Item</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Entry<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-meta z-path z-rust">errors<span class="z-punctuation z-accessor z-rust">::</span></span>ReadError<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">poll_next</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>: <span class="z-meta z-generic z-rust">Pin<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">cx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust">Poll<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Item<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> this <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-keyword z-control z-rust">match</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>state <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>Eof <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> End of file reached - terminate stream
</span>                    <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">None</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadPosition <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Reset buffers for new entry
</span>                    this<span class="z-punctuation z-accessor z-dot z-rust">.</span>entry_name<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clear</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    this<span class="z-punctuation z-accessor z-dot z-rust">.</span>current_buffer_content <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-storage z-type z-numeric z-rust">u8</span><span class="z-punctuation z-separator z-rust">;</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">32</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Seek to the next entry position
</span>                    <span class="z-storage z-type z-rust">let</span> future <span class="z-keyword z-operator z-assignment z-rust">=</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>reader<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">seek</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">tokio<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">io<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">SeekFrom<span class="z-punctuation z-accessor z-rust">::</span></span>Start<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>this<span class="z-punctuation z-accessor z-dot z-rust">.</span>position</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> future_mut <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">pin<span class="z-punctuation z-accessor z-rust">::</span></span>pin<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>future</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-keyword z-control z-rust">match</span> future_mut<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">poll</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>state <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadFlag<span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">errors<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ReadError<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending <span class="z-keyword z-operator z-rust">=></span> <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending<span class="z-punctuation z-separator z-rust">,</span>
                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadFlag <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Read the entry type flag
</span>                    <span class="z-storage z-type z-rust">let</span> future <span class="z-keyword z-operator z-assignment z-rust">=</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>reader<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read_u8</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> future_mut <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">pin<span class="z-punctuation z-accessor z-rust">::</span></span>pin<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>future</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-keyword z-control z-rust">match</span> future_mut<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">poll</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>flag</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>flag <span class="z-keyword z-operator z-assignment z-rust">=</span> flag<span class="z-punctuation z-terminator z-rust">;</span>
                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>state <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadEntryName<span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">errors<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ReadError<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending <span class="z-keyword z-operator z-rust">=></span> <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending<span class="z-punctuation z-separator z-rust">,</span>
                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadEntryName <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Read until null terminator
</span>                    <span class="z-storage z-type z-rust">let</span> future <span class="z-keyword z-operator z-assignment z-rust">=</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>reader<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read_until</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x00</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>entry_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> future_mut <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">pin<span class="z-punctuation z-accessor z-rust">::</span></span>pin<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>future</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-keyword z-control z-rust">match</span> future_mut<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">poll</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Remove null terminator
</span>                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>entry_name<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">pop</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>state <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadContent<span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">errors<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ReadError<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending <span class="z-keyword z-operator z-rust">=></span> <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending<span class="z-punctuation z-separator z-rust">,</span>
                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadContent <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Read the content file hash
</span>                    <span class="z-storage z-type z-rust">let</span> future <span class="z-keyword z-operator z-assignment z-rust">=</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>reader<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read_exact</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>current_buffer_content</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> future_mut <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">pin<span class="z-punctuation z-accessor z-rust">::</span></span>pin<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>future</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                    <span class="z-keyword z-control z-rust">match</span> future_mut<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">poll</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Update position for next entry
</span>                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>position <span class="z-keyword z-operator z-assignment z-rust">+=</span> this<span class="z-punctuation z-accessor z-dot z-rust">.</span>entry_name<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u64</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">33</span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> name + null + hash
</span>                            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Convert name bytes to str
</span>                            <span class="z-storage z-type z-rust">let</span> name <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">str<span class="z-punctuation z-accessor z-rust">::</span></span>from_utf8<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>this<span class="z-punctuation z-accessor z-dot z-rust">.</span>entry_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                                <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-path z-rust">errors<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ReadError<span class="z-punctuation z-accessor z-rust">::</span></span>InvalidUtf8<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
                            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Create static references
</span>                            <span class="z-storage z-type z-rust">let</span> static_name<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>leak<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>name<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_boxed_str</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                            <span class="z-storage z-type z-rust">let</span> static_hash<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-separator z-rust">;</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">32</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>leak<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>this<span class="z-punctuation z-accessor z-dot z-rust">.</span>current_buffer_content</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                            this<span class="z-punctuation z-accessor z-dot z-rust">.</span>state <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">State<span class="z-punctuation z-accessor z-rust">::</span></span>ReadPosition<span class="z-punctuation z-terminator z-rust">;</span>
                            <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>Entry <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                                name<span class="z-punctuation z-separator z-rust">:</span> static_name<span class="z-punctuation z-separator z-rust">,</span>
                                content_file_hash<span class="z-punctuation z-separator z-rust">:</span> static_hash<span class="z-punctuation z-separator z-rust">,</span>
                            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                            <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">errors<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ReadError<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
                        <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending <span class="z-keyword z-operator z-rust">=></span> <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending<span class="z-punctuation z-separator z-rust">,</span>
                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h2 id=why-a-state-machine>Why a State Machine?</h2><p>The state machine pattern is crucial here for several reasons:<ol><li><p><strong>Async Operation Handling</strong>: Each read operation is asynchronous and might not complete immediately. The state machine allows us to:</p> <ul><li>Resume from the correct position when an operation returns <code>Poll::Pending</code><li>Maintain context between async operations<li>Handle partial reads correctly</ul><li><p><strong>Sequential Operations</strong>: Reading an entry requires multiple steps that must happen in order:</p> <ul><li>Seek to position<li>Read flag<li>Read name<li>Read content hash The state machine ensures these operations happen in sequence while maintaining async compatibility.</ul><li><p><strong>Resource Management</strong>: The state machine helps manage buffers and intermediate state between async operations, ensuring we don't lose data between polls.</p></ol><h2 id=the-header-file-structure>The Header File Structure</h2><p>The file we're reading is a directory header file, which serves as an index or map for the actual content files. Here's how it works:<ol><li><p><strong>Header Entry Structure</strong>:</p> <pre class=z-code><code><span class="z-text z-plain">[1 byte flag][variable-length name + null][32 byte content hash]
</span></code></pre><li><p><strong>Content Hash Purpose</strong>: The <code>content_file_hash</code> field is a 32-byte hash that:</p> <ul><li>Acts as a unique identifier for the content file<li>Can be used to locate the actual content file in the filesystem<li>Provides integrity verification for the content</ul><li><p><strong>Benefits of This Approach</strong>:</p> <ul><li>Directory operations are fast since they only read metadata<li>Content files can be deduplicated (same content = same hash)<li>Content can be loaded on-demand rather than all at once<li>Directory structure remains compact</ul></ol><p>This separation of concerns between directory structure and content storage is similar to how modern filesystems handle inodes and data blocks, but using content-addressable storage based on hashes.<h2 id=trade-offs-and-considerations>Trade-offs and Considerations</h2><p>While this implementation works, the main trade-offs that developers should be aware is that when we are returning <code>Poll::Pending</code>, the next call to <code>poll_next</code> will again create a future if the previous future has not been complete. This could lead to Memory leaks and performance issue if the file is too big.<p>We will treat a technique to solve this issue in the <a href=https://jproyo.github.io/posts/2024-11-05-implementing-directory-stream-in-rust-part-2/>second part</a> of this serie.<h1 id=conclusion>Conclusion</h1><p>In this first part of our tutorial, we explored the foundational concepts behind implementing a custom directory entry stream in Rust. We examined the structure of our <code>DirEntriesIter</code> and the state machine pattern that facilitates asynchronous reading of directory entries.<p>By leveraging Rust's powerful type system and async capabilities, we created a solution that handles directory traversal. However, we also highlighted trade-offs, particularly regarding performance and memory management when dealing with large files.<p>In the upcoming <a href=https://jproyo.github.io/posts/2024-11-05-implementing-directory-stream-in-rust-part-2/>second part</a>, we will address these performance concerns and introduce a more robust implementation that minimizes the creation of multiple futures, ensuring a more efficient and reliable directory stream. Stay tuned for further insights and enhancements to our Rust directory stream implementation!</section></article></main></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/jproyo target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a><a class="nav-links social" rel="noopener noreferrer" href=https://www.linkedin.com/in/juanpabloroyo/ target=_blank> <img alt=linkedin src=/social_icons/linkedin.svg title=linkedin> </a><a class="nav-links social" rel="noopener noreferrer" href=https://twitter.com/juanpabloroyo target=_blank> <img alt=twitter src=/social_icons/twitter.svg title=twitter> </a><a class="nav-links social" rel="noopener noreferrer" href=mailto:juanpablo.royo@gmail.com target=_blank> <img alt=email src=/social_icons/email.svg title=email> </a><a class="nav-links social" rel="noopener noreferrer" href=/atom.xml target=_blank> <img alt=rss src=/social_icons/rss.svg title=rss> </a><a class="nav-links social" rel="noopener noreferrer" href=https://www.reddit.com/user/jproyo target=_blank> <img alt=reddit src=/social_icons/reddit.svg title=reddit> </a></nav><nav><span classname=desktop-only>This blog is powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a> with theme by <a rel="noopener noreferrer" href=https://syedzayyan.com/ target=_blank>SZM</a></span></nav></section><script src=https://jproyo.github.io/js/main.js></script></footer>