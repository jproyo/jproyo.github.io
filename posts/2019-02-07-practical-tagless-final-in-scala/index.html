<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        Tagless Final in Scala: A Practical example
    </title><link href=/favicons/favicon.ico rel=icon type=image/png><link href="https://jproyo.github.io/ atom.xml" title="Tech, Science, Math and more..." rel=alternate type=application/atom+xml><link href=https://jproyo.github.io/main.css media=screen rel=stylesheet><script src=https://jproyo.github.io/elasticlunr.min.js></script><script src=https://jproyo.github.io/search_index.en.js></script><script src=https://jproyo.github.io/search.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><meta name=description><meta name=description><meta content="index, nofollow" name=robots><meta content="Tech, Science, Math and more..." property=og:title><meta content=article property=og:type><meta content=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/ property=og:url><meta property=og:description><meta content="Tech, Science, Math and more..." property=og:site_name><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://jproyo.github.io>Tech, Science, Math and more...</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/posts> Articles</a><a class=nav-links href=/tags> Tags</a></nav><nav class="socials nav-navs"><div class=search-container><input placeholder="üîé   Search" id=search type=search><div class=search-results><div class=search-results__items></div></div></div><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>Tagless Final in Scala: A Practical example</h2><div class=meta>Posted on <time>2019-02-07</time><div class=post-tags><nav class="nav tags">üè∑: <a href=https://jproyo.github.io/tags/scala/>scala</a> ¬† <a href=https://jproyo.github.io/tags/fp/>fp</a> ¬† <a href=https://jproyo.github.io/tags/functional/>functional</a> ¬† <a href=https://jproyo.github.io/tags/programming/>programming</a> ¬† <a href=https://jproyo.github.io/tags/tagless/>tagless</a> ¬† <a href=https://jproyo.github.io/tags/final/>final</a> ¬†</nav></div> ||<span> 19 minute read</span></div></div><h1>Table of Contents</h1><ul><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#source-code>Source Code</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#disclaimer>Disclaimer</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#introduction>Introduction</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#problem-example>Problem example</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#imperative-approach>Imperative approach</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#tagless-final-encoding>Tagless Final Encoding</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#algebras>Algebras</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#algebra-s-interpreter>Algebra's Interpreter</a> <ul><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#program-syntax-for-comprehension-aware>Program Syntax: For-Comprehension aware</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#printing-results-the-right-way>Printing results: The right way</a></ul><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#handling-errors-sum-type-to-rescue>Handling Errors: Sum Type to Rescue</a> <ul><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#lambda-types>Lambda Types</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#interpreter-for-either-a-b>Interpreter for Either[+A,+B]</a></ul><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#testing>Testing</a><li><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#conclusion>Conclusion</a></ul><section class=body><h2 id=source-code>Source Code</h2><p>To get a complete version of the source code presented here, go here <a href=https://github.com/jproyo/imperative-to-fp/tree/demo-end>Github Repo</a>.<blockquote><p>All the examples of this post can be found on <code>demo-end</code> branch and <strong>NOT</strong> in <code>master</code></blockquote><h2 id=disclaimer>Disclaimer</h2><p>All the techniques and code that is going to be shown here are completely agnostic of any library. We are <strong>not going</strong> to use any <strong>Scala FP</strong> library such as <strong><a href=https://typelevel.org/cats/>cats</a>, <a href=https://scalaz.github.io/7/>scalaz</a> or any other</strong>. Obviously using any of those libraries could help us to implement these techniques without needing to write so much code, but the goal here is to shown how we can implement <strong>Tagless Final Encoding</strong> using only pure <strong>Scala</strong> language features.<h2 id=introduction>Introduction</h2><p>This is my first blog post about Scala and i would like to describe a well known topic for the whole <strong>Scala FP</strong> community which is <strong>Tagless Final Encoding</strong>.<p>There are so many great code examples and blog post about the subject around there, but since there is always room to understand the technique from other perspective, I decided to take the chance and maybe help others to understand it in a more practical point of view.<p>I am going to deep dive in the technique with a real use case example and in the middle i will mix it with more theoretical concepts. This journey is going to start from an <strong>imperative approach</strong> until we get to a <strong>Tagless Final FP approach</strong>. So, fasten your seat belts and lets enjoy the ride!!!<h2 id=problem-example>Problem example</h2><p>I've created an example problem to be solved based on some things of my personal work, so everything in the example could be real production code. This is obviously a minimalist version of the problem.<p>We are going to describe a <strong>Recommender Program</strong> that given an <strong>algorithm</strong> and a <strong>user</strong> is going to generate recommendations for that <strong>user</strong> based on the selected <strong>algorithm</strong>. A <strong>Recommender</strong> system could be for example the most likely <strong>recommendations</strong> you received when visit any Marketplace such as <em>Amazon, Ebay, or any other</em> after searching for some products and navigate through these sites. For example: <em>"Since you have been searching for X cars, maybe you are interested in R, Y and Z also"</em>.<p>We have the following requirements defined in terms of <strong>User Stories</strong>:<ul><li><p><em>As an user i want to get recommendations from an specific algorithm, but if there are no recommendations for this algorithm or i forgot to specify what algorithm should be use i would like to have default recommendations from the best algorithm the system has.</em></p><li><p><em>As an user i want to get a message if recommendation's algorithm i requested is wrong.</em></p><li><p><em>As an user i want to be able to be retrieve with a limited number of recommendations.</em></p></ul><h2 id=imperative-approach>Imperative approach</h2><pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> DataSource<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    userId<span class="z-punctuation z-accessor z-scala">.</span>filter<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">user</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> users<span class="z-punctuation z-accessor z-scala">.</span>exists<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>userId <span class="z-keyword z-operator z-comparison z-scala">==</span> user<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    recommenderId<span class="z-punctuation z-accessor z-scala">.</span>orElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algoDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithms<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>


  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">program</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
                <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-separator z-scala">,</span>
                <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>


      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">user</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> getUser<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>

      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">algorithm</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> getAlgorithm<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recommenderId<span class="z-punctuation z-section z-group z-end z-scala">)</span>

      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">result</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> algorithm<span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>user<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
                            <span class="z-punctuation z-accessor z-scala">.</span>orElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>emptyRecs<span class="z-punctuation z-section z-group z-begin z-scala">(</span>user<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">limitFilter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> limit<span class="z-punctuation z-accessor z-scala">.</span>getOrElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>limitDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span>

      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">resultFiltered</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
                result<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>copy<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recs <span class="z-keyword z-operator z-assignment z-scala">=</span> recs<span class="z-punctuation z-accessor z-scala">.</span>slice<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> limitFilter<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toList<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

      resultFiltered <span class="z-keyword z-control z-flow z-scala">match</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
        <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recs</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=></span><span class="z-meta z-block z-case z-first z-scala"> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span></span></span><span class="z-meta z-block z-scala">
          println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-constant z-character z-escape z-scala">\n</span>Recommnedations for userId <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">recs<span class="z-punctuation z-accessor z-scala">.</span>userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>...<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
          println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Algorithm <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algorithm<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>name</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
          println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Recs: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">recs<span class="z-punctuation z-accessor z-scala">.</span>recs</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
        <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-block z-case z-first z-scala">
        </span><span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">None</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=></span><span class="z-meta z-block z-case z-non-first z-scala"> println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>No recommendations found for userId </span><span class="z-punctuation z-definition z-variable z-scala"><span class="z-variable z-other z-scala">$</span></span><span class="z-variable z-other z-scala">userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      </span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

</span></code></pre><p>Although this imperative code version is fine, we can take the advantage of <em>for-comprehension</em> syntax sugar since we are manipulating <code>Option[+A]</code> type.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">program</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
              <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-separator z-scala">,</span>
              <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>

    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">result</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      <span class="z-variable z-parameter z-scala">user</span>           <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> getUser<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">algorithm</span>      <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> getAlgorithm<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recommenderId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">result</span>         <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> algorithm<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>user<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">limitFilter</span>     <span class="z-keyword z-operator z-assignment z-scala">=</span> limit<span class="z-punctuation z-accessor z-scala">.</span>getOrElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>limitDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">resultFiltered</span>  <span class="z-keyword z-operator z-assignment z-scala">=</span> result<span class="z-punctuation z-accessor z-scala">.</span>copy<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recs <span class="z-keyword z-operator z-assignment z-scala">=</span> recs<span class="z-punctuation z-accessor z-scala">.</span>slice<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> limitFilter<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toList<span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span> <span class="z-keyword z-control z-flow z-scala">yield</span> <span class="z-support z-constant z-scala">Result</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithm<span class="z-punctuation z-separator z-scala">,</span> resultFiltered<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    result <span class="z-keyword z-control z-flow z-scala">match</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">algoRes</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=></span><span class="z-meta z-block z-case z-first z-scala"> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span></span></span><span class="z-meta z-block z-scala">
        println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-constant z-character z-escape z-scala">\n</span>Recommnedations for userId <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>recs<span class="z-punctuation z-accessor z-scala">.</span>userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>...<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
        println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Algorithm <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>algorithm<span class="z-punctuation z-accessor z-scala">.</span>name</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
        println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Recs: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>recs<span class="z-punctuation z-accessor z-scala">.</span>recs</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-block z-case z-first z-scala">
      </span><span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">None</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=></span><span class="z-meta z-block z-case z-non-first z-scala"> println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>No recommendations found for userId </span><span class="z-punctuation z-definition z-variable z-scala"><span class="z-variable z-other z-scala">$</span></span><span class="z-variable z-other z-scala">userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    </span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

</span></code></pre><p>We can even go further and separate our program in 2 functions:<ul><li><code>getRecommendations</code>: for-comprehension where the program logic takes place<li><code>printResults</code>: print results or errors to the user.</ul><p><a name=refactor-imperative></a><pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getRecommendations</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
                         <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
                         <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Result</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">result</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      <span class="z-variable z-parameter z-scala">user</span>           <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> getUser<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">algorithm</span>      <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> getAlgorithm<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recommenderId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">result</span>         <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> executeAlgorithm<span class="z-punctuation z-section z-group z-begin z-scala">(</span>user<span class="z-punctuation z-separator z-scala">,</span> algorithm<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">limitFilter</span>     <span class="z-keyword z-operator z-assignment z-scala">=</span> limit<span class="z-punctuation z-accessor z-scala">.</span>getOrElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>limitDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">resultFiltered</span> <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> filterResults<span class="z-punctuation z-section z-group z-begin z-scala">(</span>result<span class="z-punctuation z-separator z-scala">,</span> limitFilter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span> <span class="z-keyword z-control z-flow z-scala">yield</span> <span class="z-support z-constant z-scala">Result</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithm<span class="z-punctuation z-separator z-scala">,</span> resultFiltered<span class="z-punctuation z-section z-group z-end z-scala">)</span>
    result
  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>


  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">printResults</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">result</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Result</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
    result<span class="z-punctuation z-accessor z-scala">.</span>fold<span class="z-punctuation z-section z-group z-begin z-scala">(</span>println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>No recommendations found for userId </span><span class="z-punctuation z-definition z-variable z-scala"><span class="z-variable z-other z-scala">$</span></span><span class="z-variable z-other z-scala">userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">algoRes</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-constant z-character z-escape z-scala">\n</span>Recommnedations for userId <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>recs<span class="z-punctuation z-accessor z-scala">.</span>userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>...<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Algorithm <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>algorithm<span class="z-punctuation z-accessor z-scala">.</span>name</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Recs: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>recs<span class="z-punctuation z-accessor z-scala">.</span>recs</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

  <span class="z-storage z-modifier z-access z-scala">private</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
  userId<span class="z-punctuation z-accessor z-scala">.</span>filter<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">user</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> users<span class="z-punctuation z-accessor z-scala">.</span>exists<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>userId <span class="z-keyword z-operator z-comparison z-scala">==</span> user<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-modifier z-access z-scala">private</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
  recommenderId<span class="z-punctuation z-accessor z-scala">.</span>orElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algoDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithms<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-modifier z-access z-scala">private</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">executeAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">user</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">algorithm</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    algorithm<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span>user<span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-modifier z-access z-scala">private</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">filterResults</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">result</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">limitFilter</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>result<span class="z-punctuation z-accessor z-scala">.</span>copy<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recs <span class="z-keyword z-operator z-assignment z-scala">=</span> recs<span class="z-punctuation z-accessor z-scala">.</span>slice<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> limitFilter<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toList<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

</span></code></pre><p>Now we are done with our imperative code style and we can say it is in a good shape.<p>But we don't like imperative style, we love doing <strong>Functional Programming</strong> and applying all the Math science we have at our disposal, don't we? So, lets start to refactor our code with <strong>Tagless Final Encoding</strong> approach.<h2 id=tagless-final-encoding>Tagless Final Encoding</h2><p><strong>Tagless Final Encoding</strong> is a technique for embedding a <strong>DSL</strong> (Domain Specific Language) in a <strong>Type Functional Language</strong> such as Scala, Haskell, OCaml or other similar. Since we are embedding a DSL (a.k.a. Language) we are defining a <em>Language</em> in order to use its syntax and semantic <strong>(Algebra)</strong> in our program. We are defining also an <em>interpreter</em> of the Language to indicate how it should behave on each used term <strong>(Interpreter)</strong>.<blockquote><p>If you want to visit a more advanced approach of this, I would strongly recommend after this lecture to take a look on Free Monads.</blockquote><p>We can say that in <strong>Tagless Final</strong> style there are:<ul><li><p><em><strong>Algebra</strong></em>s: Set of operations over a Structure. In a Programming language idiom could be a set of functions that operates over some Type.</p><li><p><em><strong>Interpreter</strong></em>: The way of those operations behave according to an specific Type. In a Programming language idiom the implementation of those functions depending on the specific Type.</p></ul><h2 id=algebras>Algebras</h2><p>The first thing to do with this technique is to define our <em>Algebras</em>, our <em>operations</em> that are needed to solve our domain problem. If you already have some program in a good shape but with an imperative style approach like describe it <a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#imperative-approach>above</a>, it is quite easy to define these operations because it is already provided by the semantic of the for-comprehension. In our case we have the following operations:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">executeAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">filter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

</span></code></pre><p>Now the only thing left to build our Algebra is to group those operation in different Algebras depending on the structure they are operating on:<ul><li>User: operations related to handle users<li>Algorithm: operations related to handle algorithms<li>Filter: operation for filtering results</ul><p>Since our <em>Algebras</em> are only definition of our operations we are going to use <em>Trait</em> for defining this abstract representation.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> algebras</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>

    <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> DataSource<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>

    <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> UserRepo</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> UserRepo</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">apply</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">UserR</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">UserR</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> Filter</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">filter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userRec</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> Filter</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">apply</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">Fil</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Filter</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Filter</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Fil</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> AlgorithmRepo</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">execute</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">algo</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> AlgorithmRepo</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">apply</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">Algo</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">AlgorithmRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">AlgorithmRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Algo</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

</span></code></pre><p>Here we have a couple of things perhaps new for the reader:<ul><li><p>We are defining our Algebras in Traits. So far so good. Nothing new or fancy.</p><li><p>We are defining our Types with <strong>Higher-Kinded Types</strong> parameters (<code>F[_]</code>) to abstract out the Container Structure that it is going to be use in each <em>Interpreter</em>. A <em>Higher-Kinded Type</em> or Type Constructor is a Type which constructs a new Type based on a Type Parameter. For example <code>Option[+A]</code> is a Type constructor which takes a Type, for example <code>String</code> and constructs the final Type, for example <code>Option[String]</code>. You can probe this in a Scala console with <em>:kind</em> command:</p></ul><pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">scala> :k String
String's kind is A

scala> :k Option
Option's kind is F[+A]

scala> :k Option[String]
Option[String]'s kind is A
</span></code></pre><ul><li>A last thing we are adding here in companion objects are a technique called <strong>Summoned values</strong>, which allow us to get the implicit value using the Companion Object Trait's constructor.</ul><p>With all this machinery in place we can add some utility functions to avoid calling companion objects and just calling <strong>functions</strong> from the client program:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">UserRepo</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    <span class="z-support z-constant z-scala">UserRepo</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>getUser<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">filter</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">Filter</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userRec</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    <span class="z-support z-constant z-scala">Filter</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>filter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userRec<span class="z-punctuation z-separator z-scala">,</span> limit<span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">AlgorithmRepo</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    <span class="z-support z-constant z-scala">AlgorithmRepo</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>getAlgorithm<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recommenderId<span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">execute</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">AlgorithmRepo</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">algo</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    <span class="z-support z-constant z-scala">AlgorithmRepo</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>execute<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algo<span class="z-punctuation z-separator z-scala">,</span> userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>

</span></code></pre><p>Now it is time to use our Algebras from <code>getRecommendations</code> program. In order to do that we are going to use <a href=https://docs.scala-lang.org/tutorials/FAQ/context-bounds.html>Context Bounds</a> allowing the compiler to infer implicit values from context.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getRecommendations</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">UserRepo</span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">AlgorithmRepo</span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">Filter</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span>
      <span class="z-punctuation z-section z-group z-begin z-scala">(</span> <span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
        <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
        <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Result</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
    <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      <span class="z-variable z-parameter z-scala">user</span>           <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> getUser<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">algorithm</span>      <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> getAlgorithm<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recommenderId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">result</span>         <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> execute<span class="z-punctuation z-section z-group z-begin z-scala">(</span>user<span class="z-punctuation z-separator z-scala">,</span> algorithm<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">limitFilter</span>     <span class="z-keyword z-operator z-assignment z-scala">=</span> limit<span class="z-punctuation z-accessor z-scala">.</span>getOrElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>limitDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-variable z-parameter z-scala">resultFiltered</span> <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> filter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>result<span class="z-punctuation z-separator z-scala">,</span> limitFilter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span> <span class="z-keyword z-control z-flow z-scala">yield</span> <span class="z-support z-constant z-scala">Result</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithm<span class="z-punctuation z-separator z-scala">,</span> resultFiltered<span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

</span></code></pre><h2 id=algebra-s-interpreter>Algebra's Interpreter</h2><p>Although it seems we have arrived to an acceptable solution we are not ready yet. We need to have at least one interpreter which is the real implementation of our Algebra. Recall that we are resting everything on <code>Option[+A]</code> for the moment, so our interpreter should be on <code>Option[+A]</code> Type.<p>One possible interpreter could be:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> interpreter</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>

    <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> DataSource<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>
    <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> algebras<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>

    <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> UserRepoOption</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">UserRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
        userId<span class="z-punctuation z-accessor z-scala">.</span>filter<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">user</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> users<span class="z-punctuation z-accessor z-scala">.</span>exists<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>userId <span class="z-keyword z-operator z-comparison z-scala">==</span> user<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> AlgorithmRepoOption</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">AlgorithmRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
        recommenderId<span class="z-punctuation z-accessor z-scala">.</span>orElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algoDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithms<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

      <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">execute</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">algo</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
        algo<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

    <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> FilterOption</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">Filter</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
      <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">filter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userRec</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
        <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userRec<span class="z-punctuation z-accessor z-scala">.</span>copy<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recs <span class="z-keyword z-operator z-assignment z-scala">=</span> recs<span class="z-punctuation z-accessor z-scala">.</span>slice<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> limit<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toList<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre><p>We need to do for letting the compiler infer the implicit values it is just importing our implicit values on the context.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> DataSource<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>
  <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> algebras<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>

  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">program</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
              <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-separator z-scala">,</span>
              <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>

   <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> interpreter<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>

   <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">result</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Result</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> getRecommendations<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> recommenderId<span class="z-punctuation z-separator z-scala">,</span> limit<span class="z-punctuation z-section z-group z-end z-scala">)</span>

   printResults<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> result<span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>

</span></code></pre><p>Have you notice that we are calling <code>getRecommendations</code> with <code>Option[+A]</code> as the <strong>Higher-Kinded Type</strong> or <strong>Type Constructor</strong>?. Since we have indicated in <code>getRecommendations</code> that <code>F[_]</code> is context bounded by <code>UserRepo and AlgorithmRepo and Filter</code>, and<p>$$ F[\_] \cong Option[+A] $$<p>the compiler should look for an <code>implicit</code> value for each Algebras whose <code>F</code> is <code>Option[+A]</code>. And that is what exactly we have provided to the compiler. But is this code compile and runs or only runs? Lets check<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">Œªx.x> $ sbt run
[error] value flatMap is not a member of type parameter F[program.DataSource.UserId]
[error]       user           &LT- getUser(userId)
[error]                                ^
[error] value flatMap is not a member of type parameter F[program.DataSource.Algorithm]
[error]       algorithm      &LT- getAlgorithm(recommenderId)
[error]                                     ^
[error] two errors found
</span></code></pre><p>Why is this happening? Because <code>getRecommendations</code> is <strong>Context Bound</strong> or <strong>Constrained</strong> on <code>UserRepo: AlgorithmRepo: Filter</code> and <strong>for-comprehension</strong> in <em>Scala</em> is only a <em>syntactic sugar</em> for <code>flatMap</code>, <code>map</code> and <code>withFilter</code>. Of course <code>Option[+A]</code> type implements those methods and can be used in a for-comprehension syntax, but <em>for-comprehension</em> used on <code>getRecommendations</code> doesn't know anything about <code>Option[+A]</code> or any other <em>Type</em> until it is bound in <code>program</code> function.<blockquote><p>Remember as i mentioned in <strong><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#disclaimer>Disclaimer</a></strong> section that we are not using any extra FP library to do the job. If we are using cats or scalaz we can easily <strong>Constraint</strong> <code>getRecommendations</code> with <code>FlatMap</code> or <code>Monad</code> <strong>Typeclasses</strong></blockquote><h3 id=program-syntax-for-comprehension-aware>Program Syntax: For-Comprehension aware</h3><p>We need a way to tell the compiler that <code>getRecommendations</code> supports <strong>for-comprehension</strong> syntax. We can do that creating an <strong>Algebra</strong> to support that syntax.<blockquote><p>I would like to point out that this part of the code is inspired on <strong><a href=http://degoes.net/>John De Goes</a></strong> Talk <strong>FP to the Max</strong> and i would strongly encourage you to watch this <a href="https://www.youtube.com/watch?v=sxudIMiOo68">video</a>.</blockquote><ul><li>In our Algebra we are going to have this:</ul><pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> Program</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">ab</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> Program</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">apply</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">F</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">F</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">class</span><span class="z-entity z-name z-class z-scala"> ProgramSyntax</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">f</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">F</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">F</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span>fa<span class="z-punctuation z-separator z-scala">,</span> f<span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">F</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">F</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>fa<span class="z-punctuation z-separator z-scala">,</span> afb<span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

</span></code></pre><ul><li>An in our Interpreter we need resolution bind for <code>Option[+A]</code>:</ul><pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> ProgramOption</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
        fa<span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>afb<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">ab</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> fa<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span>ab<span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre><ul><li>Last thing to do is to add <code>Program</code> <strong>Constraint</strong> to <code>getRecommendations</code>:</ul><pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getRecommendations</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">UserRepo</span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">AlgorithmRepo</span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">Filter</span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span>
      <span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
       <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
       <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Result</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
    <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
    <span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-punctuation z-accessor z-scala">.</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span>
  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p><strong>Now the code compiles and run!!</strong><h3 id=printing-results-the-right-way>Printing results: The right way</h3><p>Recalling to our printing <a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#refactor-imperative>results function</a>. In this case our <code>fold</code> over result is working because we are expecting an <code>Option[+A]</code> result, but <code>getRecommendations</code> is agnostic in that sense and <code>printResults</code> should also be.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">printResults</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-keyword z-operator z-bound z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">result</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Result</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
    result<span class="z-punctuation z-accessor z-scala">.</span>fold<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-storage z-type z-primitive z-scala">Unit</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">error</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Error </span><span class="z-punctuation z-definition z-variable z-scala"><span class="z-variable z-other z-scala">$</span></span><span class="z-variable z-other z-scala">error</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">algoRes</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span><span class="z-constant z-character z-escape z-scala">\n</span>Recommnedations for userId <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>recs<span class="z-punctuation z-accessor z-scala">.</span>userId</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span>...<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Algorithm <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>algorithm<span class="z-punctuation z-accessor z-scala">.</span>name</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-support z-function z-scala">s</span><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>Recs: <span class="z-punctuation z-definition z-expression z-scala">${</span></span><span class="z-source z-scala z-embedded">algoRes<span class="z-punctuation z-accessor z-scala">.</span>recs<span class="z-punctuation z-accessor z-scala">.</span>recs</span><span class="z-string z-quoted z-interpolated z-scala"><span class="z-punctuation z-definition z-expression z-scala">}</span><span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>This is a better version but our program doesn't compile because <code>Program</code> Algebra doesn't have defined a <code>fold</code> operation. So lets do it:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> Program</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">ab</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">fold</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">first</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">B</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">second</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">C</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> Program</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">apply</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">Prog</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Prog</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">class</span><span class="z-entity z-name z-class z-scala"> ProgramSyntax</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>

    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">f</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">Prog</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      <span class="z-support z-constant z-scala">Prog</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span>fa<span class="z-punctuation z-separator z-scala">,</span> f<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">Prog</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      <span class="z-support z-constant z-scala">Prog</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>fa<span class="z-punctuation z-separator z-scala">,</span> afb<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">fold</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">first</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">B</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">second</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-variable z-parameter z-scala">Prog</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">C</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      <span class="z-support z-constant z-scala">Prog</span><span class="z-punctuation z-accessor z-scala">.</span>fold<span class="z-punctuation z-section z-group z-begin z-scala">(</span>fa<span class="z-punctuation z-separator z-scala">,</span> first<span class="z-punctuation z-separator z-scala">,</span> second<span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre><p>Now we have defined our <code>fold</code> operation which is going to fold over <code>F</code>. It is time to add the interpretation of this operation:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> ProgramOption</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      fa<span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>afb<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">ab</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> fa<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span>ab<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">fold</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">first</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">B</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">second</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">C</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      fa<span class="z-punctuation z-accessor z-scala">.</span>fold<span class="z-punctuation z-section z-group z-begin z-scala">(</span>first<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UnknownError</span><span class="z-punctuation z-accessor z-scala">.</span>asInstanceOf<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>second<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre><p>The code compiles and runs again with an abstract version of <code>printResults</code>. Lets see some examples:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">Œªx.x> $ sbt run
[info] Done packaging.
[info] Running (fork) program.ToScalaFP
[info] Recommnedations for userId UserId(1)...
[info] Algorithm algo1
[info] Recs: List(Rec(a,0.054459512), Rec(b,0.8465745), Rec(c,0.656385),
Rec(d,0.13308495), Rec(e,0.7825986), Rec(f,0.29209626), Rec(g,0.4820329),
Rec(h,0.1532129), Rec(i,0.16719013), Rec(j,0.9551664))
[info] ------------------------------
[info] Recommnedations for userId UserId(2)...
[info] Algorithm algo2
[info] Recs: List(Rec(a,0.054459512), Rec(b,0.8465745), Rec(c,0.656385),
Rec(d,0.13308495), Rec(e,0.7825986))
[info] ------------------------------
[info] Error Unexpected Error
[info] ------------------------------
[info] Error Unexpected Error
[info] ------------------------------
[info] Error Unexpected Error
[info] ------------------------------
[info] Error Unexpected Error
[info] ------------------------------
[success] Total time: 9 s, completed Feb 17, 2019 8:45:15 PM
</span></code></pre><p>It doesn't look accurate, does it? Error cases such as <em>userId not found, no recommendations found and so on</em> are not displayed and the messages for the user are vague in those cases. This is because we are dealing with <code>Option[+A]</code> type and it doesn't give us the expressiveness we need to notify the user with the exact errors on our program.<h2 id=handling-errors-sum-type-to-rescue>Handling Errors: Sum Type to Rescue</h2><p>We need to alert program's user about what specific errors have been found during the execution. For that purpose it will be great to have our execution in terms of <code>Either[+A,+B]</code> instead of <code>Option[+A]</code>.<p>The cost of doing that with all the machinery we have defined until now is minimum because of the following:<ol><li><p><code>Either[+A,+B]</code> is a <strong>Higher-Kinded Type</strong> but with 2 Type parameters instead of 1 as our Algebras are requesting. We are going to see in a minute how to solve that problem.</p><li><p>We only need to write an <strong>interpreter</strong> for that Type, bind <code>getRecommendations</code> call with <code>Either[+A,+B]</code> and let the compiler use the correct interpreter on runtime for us.</p></ol><h3 id=lambda-types>Lambda Types</h3><p>Lets try to figure out our first problem which is how to bind a <strong>Type Constructor</strong> with 1 Type parameters (<code>Either[+A,+B]</code>) in a definition with only 1 Type parameter (<code>F[_]</code>)<p>$$ F[\_] \ncong Either[+A,+B] $$<p>We can check this incongruence in <strong>Scala</strong> console very easily<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">scala> :kind Either
Either's kind is F[+A1,+A2]
</span></code></pre><p>As we can appreciate <code>Either[+A,+B]</code> has kind <code>F[+A,+B]</code> and we are asking a kind <code>F[+A]</code>, but we cannot change our Algebras to support <code>F[+A,+B]</code> because it is not going to accept anymore <code>Option[+A]</code> and we want to support both. Instead of changing our algebra we are going to adapt <code>Either[+A,+B]</code> to be a <em>Type Constructor</em> with 1 Type parameter. For that job we are going to use <strong>Lambda Types</strong>.<p>Basically a <em>Lambda Type</em> is similar to a Partially applied function but at a Type Level. We can <strong>curry</strong> our <strong>2 parameter Type Constructor</strong> to obtain another <strong>1 parameter Type Constructor</strong>. This is how it is done:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">scala> :kind ({ type T[A] = Either[AppError, A] })#T
scala.util.Either[AppError,?]'s kind is F[+A]
</span></code></pre><p>As we can see in <em>Scala console</em> example we are fixing <strong>Left</strong> <code>Either</code> parameter type with <code>AppError</code> since all errors we are going to generate are subtypes of this, and let this phantom type be parameterized only in its <strong>Right</strong> value Type which is the Type it is going to change during execution.<blockquote><p>In our code we are going to use <a href=https://github.com/non/kind-projector>kind-projector</a> compiler plugin to avoid this boilerplate syntax.</blockquote><p>With <strong>kind-projector</strong> we can have a more readable <em>Lambda Type</em> like this:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">scala> :kind Either[AppError, ?]
scala.util.Either[AppError,?]'s kind is F[+A]
</span></code></pre><h3 id=interpreter-for-either-a-b>Interpreter for <code>Either[+A,+B]</code></h3><p>Now the only thing missing is to write our interpreter for this new type:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> interpreter</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>

  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Option Interpreters here</span>

  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> UserRepoEither</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">UserRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
        <span class="z-variable z-parameter z-scala">userParam</span> <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> userId<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toRight<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserNotProvided</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
        <span class="z-variable z-parameter z-scala">userDb</span>    <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> users<span class="z-punctuation z-accessor z-scala">.</span>find<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> <span class="z-keyword z-operator z-comparison z-scala">==</span> userParam<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toRight<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserNotFound</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userParam<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
      <span class="z-punctuation z-section z-block z-end z-scala">}</span> <span class="z-keyword z-control z-flow z-scala">yield</span> userDb
    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> AlgorithmRepoEither</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">AlgorithmRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>

  <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getAlgorithm</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span>
    <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      recommenderId<span class="z-punctuation z-accessor z-scala">.</span>orElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algoDefault<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algorithms<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
        <span class="z-punctuation z-accessor z-scala">.</span>toRight<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">AlgorithmNotFound</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>recommenderId<span class="z-punctuation z-accessor z-scala">.</span>getOrElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span>algoDefault<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>


  <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">execute</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">algo</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Algorithm</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span>
    <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      algo<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toRight<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">RecommendationsNotFound</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> algo<span class="z-punctuation z-accessor z-scala">.</span>name<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> FilterEither</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">Filter</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">filter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userRec</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">UserRec</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
      <span class="z-support z-constant z-scala">Right</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userRec<span class="z-punctuation z-accessor z-scala">.</span>copy<span class="z-punctuation z-section z-group z-begin z-scala">(</span>recs <span class="z-keyword z-operator z-assignment z-scala">=</span> recs<span class="z-punctuation z-accessor z-scala">.</span>slice<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-separator z-scala">,</span> limit<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>toList<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> ProgramEither</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">Program</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">flatMap</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
                               <span class="z-variable z-parameter z-scala">afb</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      fa<span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>afb<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">map</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">ab</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      fa<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span>ab<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">fold</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">B</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">fa</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
                               <span class="z-variable z-parameter z-scala">first</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">B</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-separator z-scala">,</span>
                               <span class="z-variable z-parameter z-scala">second</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span> <span class="z-keyword z-operator z-arrow z-scala">=></span> <span class="z-support z-class z-scala">C</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">C</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      fa<span class="z-punctuation z-accessor z-scala">.</span>fold<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">error</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span> first<span class="z-punctuation z-section z-group z-begin z-scala">(</span>error<span class="z-punctuation z-accessor z-scala">.</span>asInstanceOf<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">B</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span> second<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
<span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre><p>And we can execute both programs running on different interpreters at the same time:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">program</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span>
              <span class="z-variable z-parameter z-scala">recommenderId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-separator z-scala">,</span>
              <span class="z-variable z-parameter z-scala">limit</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">None</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-storage z-type z-primitive z-scala">Unit</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>

    <span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> interpreter<span class="z-punctuation z-accessor z-dot z-scala">.</span><span class="z-variable z-language z-underscore z-scala">_</span></span>

    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">resultEither</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
      getRecommendations<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> recommenderId<span class="z-punctuation z-separator z-scala">,</span> limit<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    printResults<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Either</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">AppError</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> resultEither<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">resultOption</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> getRecommendations<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> recommenderId<span class="z-punctuation z-separator z-scala">,</span> limit<span class="z-punctuation z-section z-group z-end z-scala">)</span>

    printResults<span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-separator z-scala">,</span> resultOption<span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>If we run this program now we can compare detailed error when we interpret the Algebra with <code>Either[+A,+B]</code> against unknown errors with <code>Option[+A]</code>:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">Œªx.x> $ sbt run
Recommnedations for userId UserId(1)...
Algorithm algo1
Recs: List(Rec(a,0.66836), Rec(b,0.8242624), Rec(c,0.74691266),
Rec(d,0.9902125), Rec(e,0.775927), Rec(f,0.015915632), Rec(g,0.19724733),
Rec(h,0.92668074), Rec(i,0.2997946), Rec(j,0.1962437))

Recommnedations for userId UserId(1)...
Algorithm algo1
Recs: List(Rec(a,0.66836), Rec(b,0.8242624), Rec(c,0.74691266),
Rec(d,0.9902125), Rec(e,0.775927), Rec(f,0.015915632), Rec(g,0.19724733),
Rec(h,0.92668074), Rec(i,0.2997946), Rec(j,0.1962437))
------------------------------


Recommnedations for userId UserId(2)...
Algorithm algo2
Recs: List(Rec(a,0.66836), Rec(b,0.8242624), Rec(c,0.74691266),
Rec(d,0.9902125), Rec(e,0.775927))

Recommnedations for userId UserId(2)...
Algorithm algo2
Recs: List(Rec(a,0.66836), Rec(b,0.8242624), Rec(c,0.74691266),
Rec(d,0.9902125), Rec(e,0.775927))
------------------------------

Error Algorithm not found for id algo5
Error Unexpected Error
------------------------------

Error User not found for id UserId(14)
Error Unexpected Error
------------------------------

Error User id must be provided
Error Unexpected Error
------------------------------

Error Recommendations not found for UserId(1) with algorithm 'algo3'
Error Unexpected Error
------------------------------


Process finished with exit code 0
</span></code></pre><h2 id=testing>Testing</h2><p>With this approach we can test our code in a straight forward way. We only need to provide a <code>Test</code> 1 parameter Type constructor and write our interpreters. Thats all.<p>To have an idea of this approach to that this could be done like this:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">
  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Provide Type parameter Test which wraps a value</span>
  <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">case </span><span class="z-storage z-type z-class z-scala">class</span><span class="z-entity z-name z-class z-scala"> Test</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-keyword z-operator z-bound z-scala">+</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">value</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>

  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Provide Interpreters for example for userRepo</span>
   <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> TestUserRepo</span></span> <span class="z-keyword z-declaration z-scala">extends</span> <span class="z-entity z-other z-inherited-class z-scala">UserRepo</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Test</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
    <span class="z-storage z-modifier z-other z-scala">override</span> <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">getUser</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userId</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Option</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Test</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">UserId</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
    <span class="z-support z-constant z-scala">Test</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>userId<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>getOrElse<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">UserId</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
  <span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>

</span></code></pre><h2 id=conclusion>Conclusion</h2><p><strong>Tagless Final Encoding</strong> is a very good technique to encode DSL and separate the interpretation of DSL definition from implementation in a pure Functional way and as i pointed out on <a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#disclaimer>Disclaimer</a> section, implementing this technique with some <strong>Scala FP</strong> library such as <strong>cats, scalaz or any other</strong> do the work strait forward and easy, removing a lot of boilerplate code we are using here, specially <strong><a href=https://jproyo.github.io/posts/2019-02-07-practical-tagless-final-in-scala/#program-syntax-for-comprehension-aware>Program Algebra</a></strong></section></article></main></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/jproyo target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a><a class="nav-links social" rel="noopener noreferrer" href=https://www.linkedin.com/in/juanpabloroyo/ target=_blank> <img alt=linkedin src=/social_icons/linkedin.svg title=linkedin> </a><a class="nav-links social" rel="noopener noreferrer" href=https://twitter.com/juanpabloroyo target=_blank> <img alt=twitter src=/social_icons/twitter.svg title=twitter> </a><a class="nav-links social" rel="noopener noreferrer" href=mailto:juanpablo.royo@gmail.com target=_blank> <img alt=email src=/social_icons/email.svg title=email> </a><a class="nav-links social" rel="noopener noreferrer" href=/atom.xml target=_blank> <img alt=rss src=/social_icons/rss.svg title=rss> </a><a class="nav-links social" rel="noopener noreferrer" href=https://www.reddit.com/user/jproyo target=_blank> <img alt=reddit src=/social_icons/reddit.svg title=reddit> </a></nav><nav><span classname=desktop-only>This blog is powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a> with theme by <a rel="noopener noreferrer" href=https://syedzayyan.com/ target=_blank>SZM</a></span></nav></section><script src=https://jproyo.github.io/js/main.js></script></footer>